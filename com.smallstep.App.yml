id: com.smallstep.App
runtime: org.gnome.Platform
runtime-version: '46'
sdk: org.gnome.Sdk
rename-icon: smallstep
finish-args:
  - --device=all
  - --env=DCONF_USER_CONFIG_DIR=.config/dconf # For GNOME proxy resolution
  - --env=GIO_EXTRA_MODULES=/app/lib/gio/modules # For GNOME proxy resolution
  - --env=GSETTINGS_BACKEND=dconf # For GNOME proxy resolution
  - --env=GTK_PATH=/app/lib/gtkmodules
  - --filesystem=~/.config/dconf:ro # For GNOME proxy resolution
  - --filesystem=~/.config/kioslaverc # For KDE proxy resolution (KDE5 only)
  - --filesystem=xdg-desktop
  - --filesystem=xdg-download # Default download directory
  - --filesystem=xdg-run/dconf # For GNOME proxy resolution
  - --filesystem=xdg-run/gvfsd
  - --persist=step-agent
  - --share=ipc
  - --share=network
  - --socket=fallback-x11
  - --socket=pcsc # Webauthn / FIDO
  - --socket=session-bus
  - --socket=system-bus
  - --socket=wayland
  - --socket=x11
  - --system-talk-name=org.freedesktop.NetworkManager
  - --talk-name=ca.desrt.dconf # For GNOME proxy resolution
  - --talk-name=com.canonical.AppMenu.Registrar
  - --talk-name=org.freedesktop.FileManager1
  - --talk-name=org.freedesktop.Notifications
  - --talk-name=org.freedesktop.ScreenSaver
  - --talk-name=org.freedesktop.secrets
  - --talk-name=org.gnome.SessionManager
  - --talk-name=org.gtk.vfs.*
  - --talk-name=org.kde.kwalletd5 # Used for password encryption under KDE5 environments
  - --talk-name=org.kde.kwalletd6 # Used for password encryption under KDE6 environments
  - --talk-name=org.kde.StatusNotifierWatcher

command: app-wrapper.sh

modules:
  - shared-modules/libappindicator/libappindicator-gtk3-12.10.json

  - name: pcsc-lite
    config-opts:
    - "--disable-libudev"
    - "--disable-libsystemd"
    - "--without-systemdsystemunitdir"
    sources:
    - type: archive
      url: https://pcsclite.apdu.fr/files/pcsc-lite-1.9.5.tar.bz2
      sha256: 9ee3f9b333537562177893559ad4f7b8d5c23ebe828eef53056c02db14049d08
      x-checker-data:
        type: anitya
        project-id: 2611
        url-template: https://pcsclite.apdu.fr/files/pcsc-lite-$version.tar.bz2
    modules:
      - shared-modules/libusb/libusb.json

  - webkit2gtk.yml

  - name: Smallstep
    buildsystem: simple
    build-commands:
      - install -Dm 644 -t /app/share/applications com.smallstep.App.desktop
      - install -Dm644 -t /app/share/metainfo/ com.smallstep.App.metainfo.xml
      - install -Dm755 -t /app/share/icons/hicolor/scalable/apps/ smallstep.png
      - install -Dm755 agent /app/bin/smallstep-agent
      - install -Dm755 app-wrapper.sh /app/bin/app-wrapper.sh
      - install -Dm755 agent-wrapper.sh /app/bin/agent-wrapper.sh
      - install -Dm755 gui /app/bin/smallstep
    sources:
      - type: file
        path: com.smallstep.App.desktop
      - type: file
        path: com.smallstep.App.metainfo.xml
      - type: file
        path: smallstep.png
      - type: file
        path: ../../bin/gui
      - type: file
        path: ../../bin/agent
      - type: file
        path: app-wrapper.sh
      - type: file
        path: agent-wrapper.sh
